import { create } from "zustand";
import { auth, db } from "../firebase";
import {
  addDoc,
  collection,
  deleteDoc,
  doc,
  updateDoc,
} from "firebase/firestore";
import { v4 as uuidv4 } from "uuid";
import { router } from "../routes/router";

export interface FormElement {
  id?: string;
  name: string;
  position: {
    x: number;
    y: number;
  };
  placeholder: string;
  is_required: boolean;
  label: string;
  type: string;
  options?: string[];
  position_canva?: number;
  // | "input"
  // | "textarea"
  // | "checkbox"
  // | "radio"
  // | "select"
  // | "date"
  // | "email"
  // | "button";
}

export interface TempData {
  id: string;
  templateName: string;
  description: string;
  userId: string;
  elements: FormElement[];
  createdAt: string;
  templateId: string;
}

interface FormBuilder {
  elements: FormElement[];
  is_preview: boolean;
  preview: FormElement[];
  templates: TempData[];
  selectedElement: FormElement | null;
  currentTemp: TempData | null;
  isEditTemp: boolean;
  startEditTemp: () => void;
  closeEditTemp: () => void;
  selectTemplate: (templateId: string) => void;
  updateTemp: () => void;
  deleteTemp: (id: string) => void;
  addElement: (element: FormElement) => void;
  selectElement: (element: FormElement | null) => void;
  removeElement: (id: string) => void;
  clearElements: () => void;
  setProperties: () => void;
  updateElement: (id: string, updates: Partial<FormElement>) => void;
  getTemplate: (tempDate: TempData[]) => void;
  addTemplate: (name: string, description?: string) => void;
  addPreview: (element: FormElement[]) => void;
}

export const useFormStore = create<FormBuilder>((set, get) => ({
  elements: [],
  selectedElement: null,
  currentTemp: null,
  is_preview: true,
  preview: [],
  templates: [],
  isEditTemp: false,

  startEditTemp() {
    set({
      isEditTemp: true,
    });
    router.navigate({
      to: "/building",
    });
  },

  closeEditTemp() {
    set({
      isEditTemp: false,
    });
  },

  selectTemplate(templateId) {
    const temp = get().templates.find((item) => item.templateId === templateId);

    set({
      currentTemp: temp,
    });
  },

  addElement(element) {
    const data: FormElement = {
      ...element,
      id: Date.now().toString(36).substring(2, 9),
    };

    set((state) => ({
      elements: [...state.elements, data],
    }));
  },

  addPreview(value) {
    set({
      preview: value,
    });

    router.navigate({
      to: "/preview",
    });
  },

  selectElement(element) {
    if (element && element.id === "") return;
    const filterElement = get().elements.find(
      (item) => item.id === element?.id
    );

    set({
      selectedElement: filterElement,
    });
  },

  removeElement(id) {
    if (!id) return;
    const remove = get().elements.filter((item) => item.id !== id);

    set({
      elements: remove,
      selectedElement: null,
    });
  },

  clearElements() {
    set({
      elements: [],
      selectedElement: null,
    });
  },

  setProperties() {
    set((state) => ({
      is_preview: !state.is_preview,
    }));
  },

  updateElement(id, updates) {
    set((state) => {
      const isSelected = state.selectedElement?.id === id;
      return {
        elements: state.elements.map((item) =>
          item.id === id ? { ...item, ...updates } : item
        ),
        selectedElement: isSelected
          ? { ...state.selectedElement!, ...updates }
          : state.selectedElement,
      };
    });
  },

  getTemplate(tempDate) {
    set({
      templates: tempDate,
    });
  },

  async addTemplate(name, description) {
    const userId = auth.currentUser?.uid;
    const elements = get().elements;
    if (!name || !userId || !elements) return;

    const newForm = {
      id: uuidv4(),
      userId: userId,
      templateName: name,
      description: description || "",
      elements: elements,
      createdAt: new Date(),
    };

    const data = await addDoc(collection(db, "templates"), newForm);
    await updateDoc(data, { templateId: data.id });

    return data;
  },

  updateTemp() {},

  async deleteTemp(id) {
    if (!id) return;
    try {
      const deleteTemplate = await deleteDoc(doc(db, "templates", id)).then(
        () => {
          set((prev) => ({
            templates: [
              ...prev.templates.filter((item) => item.templateId !== id),
            ],
          }));
        }
      );

      return deleteTemplate;
    } catch (error) {
      console.error(error);
    }
  },
}));
